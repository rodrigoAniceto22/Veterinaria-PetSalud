<div class="container mt-4">
  <div class="row">
    <div class="col-md-10 offset-md-1">
      <div class="card">
        <div class="card-header">
          <h4>
            <i class="fas fa-money-bill-wave"></i>
            {{ esEdicion ? 'Editar Pago' : 'Nuevo Pago' }}
          </h4>
        </div>
        <div class="card-body">
          <form (ngSubmit)="guardar()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Dueño *</label>
                <select 
                  class="form-select" 
                  [(ngModel)]="pago.dueno.idDueno"
                  name="idDueno"
                  (change)="onDuenoChange()"
                  required>
                  <option [value]="0">Seleccione un dueño...</option>
                  <option *ngFor="let dueno of duenos" [value]="dueno.idDueno">
                    {{ dueno.nombres }} {{ dueno.apellidos }} - {{ dueno.dni }}
                  </option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Mascota</label>
                <select 
                  class="form-select" 
                  [(ngModel)]="pago.mascota"
                  name="mascota">
                  <option [ngValue]="undefined">Sin mascota específica</option>
                  <option *ngFor="let mascota of mascotas" [ngValue]="{idMascota: mascota.idMascota, nombre: mascota.nombre}">
                    {{ mascota.nombre }} - {{ mascota.especie }}
                  </option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Tipo de Pago</label>
                <select 
                  class="form-select" 
                  [(ngModel)]="pago.tipoPago"
                  name="tipoPago">
                  <option value="">Seleccione...</option>
                  <option *ngFor="let tipo of tiposPago" [value]="tipo">{{ tipo }}</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Estado</label>
                <select 
                  class="form-select" 
                  [(ngModel)]="pago.estado"
                  name="estado">
                  <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Concepto *</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="pago.concepto"
                name="concepto"
                required>
            </div>

            <!-- Internamiento -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [(ngModel)]="pago.esInternamiento"
                  name="esInternamiento"
                  id="esInternamiento"
                  (change)="onInternamientoChange()">
                <label class="form-check-label" for="esInternamiento">
                  <strong>Es un Internamiento</strong>
                </label>
              </div>
            </div>

            <div *ngIf="pago.esInternamiento" class="border p-3 mb-3 bg-light">
              <h6 class="mb-3"><i class="fas fa-bed"></i> Datos de Internamiento</h6>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Fecha Inicio</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="pago.fechaInicioInternamiento"
                    name="fechaInicioInternamiento">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Fecha Fin</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    [(ngModel)]="pago.fechaFinInternamiento"
                    name="fechaFinInternamiento">
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Días de Internamiento</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="pago.diasInternamiento"
                    name="diasInternamiento"
                    (change)="calcularMontoInternamiento()"
                    min="1">
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Costo por Día (S/)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="pago.costoDiaInternamiento"
                    name="costoDiaInternamiento"
                    (change)="calcularMontoInternamiento()"
                    step="0.01"
                    min="0">
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Monto Total (S/)</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="pago.monto"
                    name="montoInternamiento"
                    step="0.01"
                    readonly>
                </div>
              </div>
            </div>

            <div class="row" *ngIf="!pago.esInternamiento">
              <div class="col-md-6 mb-3">
                <label class="form-label">Monto (S/) *</label>
                <input 
                  type="number" 
                  class="form-control" 
                  [(ngModel)]="pago.monto"
                  name="monto"
                  step="0.01"
                  min="0"
                  required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Método de Pago</label>
                <select 
                  class="form-select" 
                  [(ngModel)]="pago.metodoPago"
                  name="metodoPago">
                  <option value="">Seleccione...</option>
                  <option *ngFor="let metodo of metodosPago" [value]="metodo">{{ metodo }}</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Fecha Emisión</label>
                <input 
                  type="date" 
                  class="form-control" 
                  [(ngModel)]="pago.fechaEmision"
                  name="fechaEmision">
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Fecha Vencimiento</label>
                <input 
                  type="date" 
                  class="form-control" 
                  [(ngModel)]="pago.fechaVencimiento"
                  name="fechaVencimiento">
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Fecha Pago</label>
                <input 
                  type="date" 
                  class="form-control" 
                  [(ngModel)]="pago.fechaPago"
                  name="fechaPago">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <textarea 
                class="form-control" 
                rows="3"
                [(ngModel)]="pago.observaciones"
                name="observaciones"></textarea>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="volver()"
                [disabled]="enviando">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button 
                type="submit" 
                class="btn btn-primary"
                [disabled]="enviando">
                <i class="fas fa-save"></i>
                {{ enviando ? 'Guardando...' : 'Guardar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>