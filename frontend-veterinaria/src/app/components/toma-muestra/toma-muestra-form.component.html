<div class="container-fluid py-4">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="fas fa-syringe me-2"></i>
        <span *ngIf="!modoEdicion && !modoVista">Nueva Toma de Muestra</span>
        <span *ngIf="modoEdicion">Editar Toma de Muestra</span>
        <span *ngIf="modoVista">Detalles de Toma de Muestra</span>
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><a routerLink="/toma-muestras">Toma de Muestras</a></li>
          <li class="breadcrumb-item active">{{ modoEdicion ? 'Editar' : (modoVista ? 'Ver' : 'Nueva') }}</li>
        </ol>
      </nav>
    </div>
    <button class="btn btn-outline-secondary" (click)="volver()">
      <i class="fas fa-arrow-left me-2"></i>Volver
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3">Cargando información...</p>
  </div>

  <!-- Formulario -->
  <div *ngIf="!loading" class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Información de la Toma de Muestra</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="tomaMuestraForm" (ngSubmit)="onSubmit()">
            
            <!-- Código de Muestra y Fecha/Hora -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="codigoMuestra" class="form-label">Código de Muestra</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                  <input type="text" class="form-control" id="codigoMuestra" formControlName="codigoMuestra"
                         placeholder="TM240115-0001"
                         [class.is-valid]="codigoMuestra?.valid && codigoMuestra?.touched">
                  <button class="btn btn-outline-secondary" type="button" 
                          (click)="generarCodigoMuestra()"
                          [disabled]="modoVista">
                    <i class="fas fa-sync-alt"></i> Generar
                  </button>
                </div>
                <small class="text-muted">Opcional - Se puede generar automáticamente</small>
              </div>

              <div class="col-md-6">
                <label for="fechaHora" class="form-label">Fecha y Hora <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                  <input type="datetime-local" class="form-control" id="fechaHora" formControlName="fechaHora"
                         [class.is-invalid]="fechaHora?.invalid && fechaHora?.touched"
                         [class.is-valid]="fechaHora?.valid && fechaHora?.touched">
                  <div class="invalid-feedback" *ngIf="fechaHora?.invalid && fechaHora?.touched">
                    La fecha y hora son requeridas
                  </div>
                </div>
              </div>
            </div>

            <!-- Orden Veterinaria -->
            <div class="mb-3">
              <label for="orden" class="form-label">Orden Veterinaria <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-medical"></i></span>
                <select class="form-select" id="orden" formControlName="orden"
                        [class.is-invalid]="orden?.invalid && orden?.touched"
                        [class.is-valid]="orden?.valid && orden?.touched">
                  <option value="">Seleccione orden</option>
                  <option *ngFor="let ord of ordenes" [value]="ord.idOrden">
                    Orden #{{ ord.idOrden }} - {{ ord.tipoExamen }} - {{ ord.mascota?.nombre }}
                    ({{ ord.veterinario?.nombres }} {{ ord.veterinario?.apellidos }})
                  </option>
                </select>
                <button *ngIf="orden?.value && modoVista" 
                        class="btn btn-outline-info" 
                        type="button" 
                        (click)="verOrden()">
                  <i class="fas fa-eye"></i> Ver Orden
                </button>
                <div class="invalid-feedback" *ngIf="orden?.invalid && orden?.touched">
                  Debe seleccionar una orden
                </div>
              </div>
              
              <!-- Info de la orden seleccionada -->
              <div *ngIf="getOrdenSeleccionada()" class="alert alert-info mt-2 mb-0">
                <div class="row">
                  <div class="col-md-6">
                    <strong><i class="fas fa-paw me-1"></i>Mascota:</strong> {{ getOrdenSeleccionada()?.mascota?.nombre }}
                    <br>
                    <strong><i class="fas fa-dog me-1"></i>Especie:</strong> {{ getOrdenSeleccionada()?.mascota?.especie }}
                  </div>
                  <div class="col-md-6">
                    <strong><i class="fas fa-user-md me-1"></i>Veterinario:</strong> 
                    {{ getOrdenSeleccionada()?.veterinario?.nombres }} {{ getOrdenSeleccionada()?.veterinario?.apellidos }}
                    <br>
                    <strong><i class="fas fa-clipboard me-1"></i>Examen:</strong> {{ getOrdenSeleccionada()?.tipoExamen }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Tipo de Muestra y Método de Obtención -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="tipoMuestra" class="form-label">Tipo de Muestra <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-vial"></i></span>
                  <select class="form-select" id="tipoMuestra" formControlName="tipoMuestra"
                          [class.is-invalid]="tipoMuestra?.invalid && tipoMuestra?.touched"
                          [class.is-valid]="tipoMuestra?.valid && tipoMuestra?.touched">
                    <option value="">Seleccione tipo</option>
                    <option *ngFor="let tipo of tiposMuestra" [value]="tipo">{{ tipo }}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="tipoMuestra?.invalid && tipoMuestra?.touched">
                    El tipo de muestra es requerido
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <label for="metodoObtencion" class="form-label">Método de Obtención</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-syringe"></i></span>
                  <select class="form-select" id="metodoObtencion" formControlName="metodoObtencion">
                    <option value="">Seleccione método</option>
                    <option *ngFor="let metodo of metodosObtencion" [value]="metodo">{{ metodo }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Volumen y Condiciones -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="volumenMuestra" class="form-label">Volumen de Muestra</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-flask"></i></span>
                  <input type="text" class="form-control" id="volumenMuestra" formControlName="volumenMuestra"
                         placeholder="Ej: 5ml, 10ml, 2 tubos">
                  <span class="input-group-text">ml / unidades</span>
                </div>
                <small class="text-muted">Especifique volumen o cantidad</small>
              </div>

              <div class="col-md-6">
                <label for="condicionesMuestra" class="form-label">Condiciones de Muestra</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-thermometer-half"></i></span>
                  <select class="form-select" id="condicionesMuestra" formControlName="condicionesMuestra">
                    <option value="">Seleccione condición</option>
                    <option *ngFor="let condicion of condicionesMuestra" [value]="condicion">{{ condicion }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Técnico Responsable -->
            <div class="mb-3">
              <label for="tecnico" class="form-label">Técnico Responsable <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user-nurse"></i></span>
                <select class="form-select" id="tecnico" formControlName="tecnico"
                        [class.is-invalid]="tecnico?.invalid && tecnico?.touched"
                        [class.is-valid]="tecnico?.valid && tecnico?.touched">
                  <option value="">Seleccione técnico</option>
                  <option *ngFor="let tec of tecnicos" [value]="tec.idTecnico">
                    {{ tec.nombres }} {{ tec.apellidos }} 
                    <span *ngIf="tec.especialidad"> - {{ tec.especialidad }}</span>
                  </option>
                </select>
                <div class="invalid-feedback" *ngIf="tecnico?.invalid && tecnico?.touched">
                  Debe seleccionar un técnico
                </div>
              </div>
            </div>

            <!-- Estado -->
            <div class="mb-3">
              <label for="estado" class="form-label">Estado <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-flag"></i></span>
                <select class="form-select" id="estado" formControlName="estado"
                        [class.is-invalid]="estado?.invalid && estado?.touched"
                        [class.is-valid]="estado?.valid && estado?.touched">
                  <option *ngFor="let est of estados" [value]="est">{{ est }}</option>
                </select>
                <div class="invalid-feedback" *ngIf="estado?.invalid && estado?.touched">
                  El estado es requerido
                </div>
              </div>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                PROGRAMADA: Aún no se realiza | REALIZADA: Muestra tomada | PROCESANDO: En análisis | COMPLETADA: Finalizada
              </small>
            </div>

            <!-- Observaciones -->
            <div class="mb-3">
              <label for="observaciones" class="form-label">Observaciones</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-notes-medical"></i></span>
                <textarea class="form-control" id="observaciones" formControlName="observaciones"
                          rows="4" 
                          placeholder="Ingrese observaciones sobre la toma de muestra, dificultades, recomendaciones..."></textarea>
              </div>
              <small class="text-muted">Opcional - Información adicional relevante</small>
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="button" class="btn btn-secondary" (click)="volver()">
                <i class="fas fa-times me-2"></i>Cancelar
              </button>
              
              <button *ngIf="modoVista" type="button" class="btn btn-warning" (click)="editar()">
                <i class="fas fa-edit me-2"></i>Editar
              </button>

              <button *ngIf="!modoVista" type="submit" class="btn btn-primary" 
                      [disabled]="guardando || tomaMuestraForm.invalid">
                <span *ngIf="!guardando">
                  <i class="fas fa-save me-2"></i>{{ modoEdicion ? 'Actualizar' : 'Guardar' }}
                </span>
                <span *ngIf="guardando">
                  <span class="spinner-border spinner-border-sm me-2"></span>Guardando...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Información adicional (solo en modo vista) -->
      <div *ngIf="modoVista" class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Acciones Relacionadas</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2">
                <i class="fas fa-file-medical me-2 text-primary"></i>
                <a [routerLink]="['/ordenes/ver', orden?.value]" class="text-decoration-none">
                  Ver orden veterinaria completa
                </a>
              </p>
              <p class="mb-0">
                <i class="fas fa-user-nurse me-2 text-success"></i>
                <a [routerLink]="['/tecnicos/ver', tecnico?.value]" class="text-decoration-none">
                  Ver perfil del técnico
                </a>
              </p>
            </div>
            <div class="col-md-6">
              <p class="mb-2">
                <i class="fas fa-flask me-2 text-warning"></i>
                <a routerLink="/resultados" [queryParams]="{orden: orden?.value}" class="text-decoration-none">
                  Ver resultados de esta orden
                </a>
              </p>
              <p class="mb-0">
                <i class="fas fa-print me-2 text-danger"></i>
                <a href="javascript:void(0)" class="text-decoration-none" (click)="notificacionService.info('Función en desarrollo')">
                  Imprimir etiqueta de muestra
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>